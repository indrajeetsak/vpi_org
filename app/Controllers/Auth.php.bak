<?php

namespace App\Controllers;

use App\Models\UserModel;
use CodeIgniter\Controller;

class Auth extends BaseController
{
    protected $session;
    protected $userModel;

    public function __construct()
    {
        $this->session = session();
        $this->userModel = new UserModel();
    }    public function index()
    {
        return redirect()->to('auth/login');
    }

    public function login()
    {
        if ($this->session->get('isLoggedIn')) {
            $userId = $this->session->get('user_id');
            $user = $this->userModel->find($userId);
            if ($user) {
                return redirect()->to('dashboard');
            }
            // If user not found but session exists, clear session
            $this->session->destroy();
        }
        return view('auth/login');
    }

    public function register()
    {
        if ($this->session->get('isLoggedIn')) {
            return redirect()->to('dashboard');
        }

        // Check which step we're on
        $step = $this->session->get('registration_step') ?? 1;
        
        // Get any saved registration data
        $data = [
            'step' => $step,
            'savedData' => $this->session->get('registration_data') ?? []
        ];
        
        if (session('errors')) {
            $data['errors'] = session('errors');
        }

        // Load the appropriate view based on the step
        switch ($step) {
            case 1:
                return view('auth/register_step1', $data);
            case 2:
                return view('auth/register_step2', $data);
            case 3:
                return view('auth/register_step3', $data);
            case 'summary':
                return view('auth/register_summary', $data);
            default:
                // Reset to step 1 if invalid step
                $this->session->remove('registration_step');
                $this->session->remove('registration_data');
                return view('auth/register_step1', $data);
        }
    }

    public function processRegistration()
    {
        helper(['form', 'array']);

        // Validation rules
        // Ensure server-side rules match required fields in the form
        $rules = [
            'first_name' => 'required|min_length[2]',
            'last_name'  => 'required|min_length[2]',
            'email'      => 'required|valid_email|is_unique[users.email]',
            'mobile'     => 'required|min_length[10]|is_unique[users.mobile]',
            'date_of_birth' => 'required|valid_date',
            'gender'     => 'required|in_list[male,female,other]', // Consider adding more specific validation if needed
            'photo'      => 'uploaded[photo]|max_size[photo,2048]|mime_in[photo,image/jpg,image/jpeg,image/png]', // Add photo validation
            'password'   => 'required|min_length[8]', // Consider adding strong password rules (regex)
            'confirm_password' => 'required|matches[password]', // Add confirm password validation
            'father_name' => 'required', // Added based on form
            'mother_name' => 'required', // Added based on form
            'aadhaar_number' => 'required|numeric|exact_length[12]|is_unique[users.aadhaar_number]', // Added based on form, added unique and exact_length
            'state' => 'required', // Added based on form
            'district' => 'required', // Added based on form
            'mla_area' => 'required', // Added based on form
            'block' => 'required', // Added based on form
            'address_line1' => 'required',
            'pin_code' => 'required|numeric|min_length[6]'
        ];

        if (!$this->validate($rules)) {
            log_message('error', 'Registration validation failed: ' . json_encode($this->validator->getErrors()));
            return redirect()->back()->withInput()->with('errors', $this->validator->getErrors());
        }

        // Handle photo upload
        $photo = $this->request->getFile('photo');
        $photoPath = null;
        
        if ($photo && $photo->isValid() && !$photo->hasMoved()) {
            $newName = $photo->getRandomName();
            if ($photo->move(WRITEPATH . 'uploads/photos', $newName)) {
                // Store only the filename, not the full path segment
                $photoPath = $newName;
            }
        }

        // Prepare user data
        $userData = [
            'first_name' => $this->request->getPost('first_name'),
            'last_name' => $this->request->getPost('last_name'),
            'email' => $this->request->getPost('email'),
            'mobile' => $this->request->getPost('mobile'),
            'alternate_mobile' => $this->request->getPost('alternate_mobile'),
            'password' => $this->request->getPost('password'),
            'date_of_birth' => $this->request->getPost('date_of_birth'),
            'gender' => $this->request->getPost('gender'),
            'photo' => $photoPath,
            'father_name' => $this->request->getPost('father_name'),
            'mother_name' => $this->request->getPost('mother_name'),
            'aadhaar_number' => $this->request->getPost('aadhaar_number'),
            'state' => $this->request->getPost('state'),
            'district' => $this->request->getPost('district'),
            'mla_area' => $this->request->getPost('mla_area'),
            'block' => $this->request->getPost('block'),
            'ls' => $this->request->getPost('ls'),
            '2ls' => $this->request->getPost('2ls'),
            '3ls' => $this->request->getPost('3ls'),
            '4ls' => $this->request->getPost('4ls'),
            'address_line1' => $this->request->getPost('address_line1'),
            'address_line2' => $this->request->getPost('address_line2'),
            'pin_code' => $this->request->getPost('pin_code'),
            'status' => 'pending'
        ];

        try {
            if ($this->userModel->insert($userData)) {
                $this->session->setFlashdata('success', 'Registration successful! Please login to continue.');
                return redirect()->to('auth/login');
            } else {
                log_message('error', 'Failed to insert user: ' . json_encode($this->userModel->errors()));
                return redirect()->back()->withInput()->with('error', 'Registration failed. Please try again.');
            }
        } catch (\Exception $e) {
            log_message('error', 'Registration exception: ' . $e->getMessage());
            return redirect()->back()->withInput()->with('error', 'An error occurred during registration. Please try again.');
        }
    }

    public function authenticate()
    {
        $email = $this->request->getPost('email');
        $password = $this->request->getPost('password');

        $rules = [
            'email' => 'required|valid_email',
            'password' => 'required'
        ];

        if (!$this->validate($rules)) {
            return redirect()->back()->withInput()->with('errors', $this->validator->getErrors());
        }

        $user = $this->userModel->where('email', $email)->first();

        if (!$user) {
            return redirect()->back()->withInput()->with('error', 'Email not found');
        }

        if (!password_verify($password, $user['password'])) {
            return redirect()->back()->withInput()->with('error', 'Invalid password');
        }

        // Set session data
        $sessionData = [
            'user_id' => $user['id'],
            'email' => $user['email'],
            'isLoggedIn' => true,
            'isAdmin' => $user['is_admin'] ?? false
        ];
        
        $this->session->set($sessionData);
        return redirect()->to('dashboard');
    }    public function authenticateMobile()
    {
        $mobile = $this->request->getPost('mobile');
        $password = $this->request->getPost('password');

        log_message('debug', '---------------------');
        log_message('debug', 'Login attempt started');
        log_message('debug', 'Mobile: ' . $mobile);
        log_message('debug', 'Raw password length: ' . strlen($password));
        log_message('debug', 'Raw password first char: ' . substr($password, 0, 1));

        $rules = [
            'mobile' => 'required|min_length[10]',
            'password' => 'required',
        ];

        if (!$this->validate($rules)) {
            log_message('debug', 'Validation failed: ' . json_encode($this->validator->getErrors()));
            return redirect()->back()->withInput()->with('error', 'Please check your credentials');
        }

        $user = $this->userModel->where('mobile', $mobile)->first();

        if ($user === null) {
            log_message('debug', 'User not found with mobile: ' . $mobile);
            return redirect()->back()->withInput()->with('error', 'Mobile number not found');
        }

        log_message('debug', 'Found user: ' . json_encode($user));
        log_message('debug', 'Stored password hash: ' . $user['password']);
        
        // Test both with and without trimming whitespace
        $rawPassword = $password;
        $trimmedPassword = trim($password);
        
        log_message('debug', 'Testing raw password verify: ' . ($rawPassword === $trimmedPassword ? 'matches trimmed' : 'different from trimmed'));
        
        $rawVerify = password_verify($rawPassword, $user['password']);
        $trimmedVerify = password_verify($trimmedPassword, $user['password']);
        
        log_message('debug', 'Raw password verify result: ' . ($rawVerify ? 'true' : 'false'));
        log_message('debug', 'Trimmed password verify result: ' . ($trimmedVerify ? 'true' : 'false'));

        if (!$rawVerify && !$trimmedVerify) {
            log_message('debug', 'Invalid password for user: ' . $mobile);
            return redirect()->back()->withInput()->with('error', 'Invalid password');
        }

        // Set up the session
        $sessionData = [
            'user_id' => $user['id'],
            'first_name' => $user['first_name'],
            'last_name' => $user['last_name'],
            'mobile' => $user['mobile'],
            'email' => $user['email'],
            'isLoggedIn' => true,
            'isAdmin' => (bool)$user['is_admin']
        ];
        
        $this->session->set($sessionData);
        log_message('debug', 'Session data set: ' . json_encode($sessionData));

        // Redirect based on user type
        if ($user['is_admin']) {
            return redirect()->to('admin');
        }
        return redirect()->to('dashboard');
    }

    public function logout()
    {
        $this->session->destroy();
        return redirect()->to('auth/login')->with('success', 'Successfully logged out');
    }

    public function register()
    {
        if ($this->session->get('isLoggedIn')) {
            return redirect()->to('dashboard');
        }

        // Check which step we're on
        $step = $this->session->get('registration_step') ?? 1;
        
        // Get any saved registration data
        $data = [
            'step' => $step,
            'savedData' => $this->session->get('registration_data') ?? []
        ];
        
        if (session('errors')) {
            $data['errors'] = session('errors');
        }

        // Load the appropriate view based on the step
        switch ($step) {
            case 1:
                return view('auth/register_step1', $data);
            case 2:
                return view('auth/register_step2', $data);
            case 3:
                return view('auth/register_step3', $data);
            case 'summary':
                return view('auth/register_summary', $data);
            default:
                // Reset to step 1 if invalid step
                $this->session->remove('registration_step');
                $this->session->remove('registration_data');
                return view('auth/register_step1', $data);
        }
    }

    public function processStep1()
    {
        helper(['form', 'array']);

        $rules = [
            'first_name' => 'required|min_length[2]',
            'last_name'  => 'required|min_length[2]',
            'date_of_birth' => 'required|valid_date',
            'gender'     => 'required|in_list[male,female,other]',
            'photo'      => 'uploaded[photo]|max_size[photo,2048]|mime_in[photo,image/jpg,image/jpeg,image/png]',
            'mobile'     => 'required|min_length[10]|is_unique[users.mobile]',
            'alternate_mobile' => 'permit_empty|min_length[10]',
            'email'      => 'required|valid_email|is_unique[users.email]'
        ];

        if (!$this->validate($rules)) {
            return redirect()->back()->withInput()->with('errors', $this->validator->getErrors());
        }

        // Handle photo upload
        $photo = $this->request->getFile('photo');
        $photoPath = null;
        
        if ($photo && $photo->isValid() && !$photo->hasMoved()) {
            $newName = $photo->getRandomName();
            if ($photo->move(WRITEPATH . 'uploads/photos', $newName)) {
                $photoPath = $newName;
            }
        }

        // Store step 1 data in session
        $stepData = [
            'first_name' => $this->request->getPost('first_name'),
            'last_name' => $this->request->getPost('last_name'),
            'date_of_birth' => $this->request->getPost('date_of_birth'),
            'gender' => $this->request->getPost('gender'),
            'photo' => $photoPath,
            'mobile' => $this->request->getPost('mobile'),
            'alternate_mobile' => $this->request->getPost('alternate_mobile'),
            'email' => $this->request->getPost('email')
        ];

        // Save data and advance to next step
        $this->saveRegistrationData($stepData);
        $this->session->set('registration_step', 2);
        
        return redirect()->to('auth/register');
    }

    public function processStep2()
    {
        helper(['form', 'array']);

        $rules = [
            'state' => 'required',
            'district' => 'required',
            'mla_area' => 'required',
            'block' => 'required',
            'father_name' => 'required',
            'mother_name' => 'required',
            'aadhaar_number' => 'required|numeric|exact_length[12]|is_unique[users.aadhaar_number]'
        ];

        if (!$this->validate($rules)) {
            return redirect()->back()->withInput()->with('errors', $this->validator->getErrors());
        }

        // Store step 2 data in session
        $stepData = [
            'state' => $this->request->getPost('state'),
            'district' => $this->request->getPost('district'),
            'mla_area' => $this->request->getPost('mla_area'),
            'block' => $this->request->getPost('block'),
            'ls' => $this->request->getPost('ls'),
            '2ls' => $this->request->getPost('2ls'),
            '3ls' => $this->request->getPost('3ls'),
            '4ls' => $this->request->getPost('4ls'),
            'father_name' => $this->request->getPost('father_name'),
            'mother_name' => $this->request->getPost('mother_name'),
            'aadhaar_number' => $this->request->getPost('aadhaar_number')
        ];

        // Save data and advance to next step
        $this->saveRegistrationData($stepData);
        $this->session->set('registration_step', 3);
        
        return redirect()->to('auth/register');
    }

    public function processStep3()
    {
        helper(['form', 'array']);

        $rules = [
            'address_line1' => 'required',
            'address_line2' => 'permit_empty',
            'pin_code' => 'required|numeric|min_length[6]',
            'password' => 'required|min_length[8]|regex_match[/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/]',
            'confirm_password' => 'required|matches[password]'
        ];

        if (!$this->validate($rules)) {
            return redirect()->back()->withInput()->with('errors', $this->validator->getErrors());
        }

        // Store step 3 data in session
        $stepData = [
            'address_line1' => $this->request->getPost('address_line1'),
            'address_line2' => $this->request->getPost('address_line2'),
            'pin_code' => $this->request->getPost('pin_code'),
            'password' => $this->request->getPost('password')
        ];

        // Save data and advance to summary
        $this->saveRegistrationData($stepData);
        $this->session->set('registration_step', 'summary');
        
        return redirect()->to('auth/register');
    }

    public function confirmRegistration()
    {
        $registrationData = $this->session->get('registration_data');
        
        if (!$registrationData) {
            return redirect()->to('auth/register');
        }

        try {
            // Insert the user
            if ($userId = $this->userModel->insert($registrationData)) {
                // Clear registration session data
                $this->session->remove('registration_step');
                $this->session->remove('registration_data');
                
                // Set success message
                $this->session->setFlashdata('success', 'Registration successful! You can now login with your mobile number.');
                
                // Redirect to login
                return redirect()->to('auth/login');
            }
            
            log_message('error', 'Failed to insert user: ' . json_encode($this->userModel->errors()));
            return redirect()->back()->with('error', 'Registration failed. Please try again.');
            
        } catch (\Exception $e) {
            log_message('error', 'Registration exception: ' . $e->getMessage());
            return redirect()->back()->with('error', 'An error occurred during registration. Please try again.');
        }
    }

    private function saveRegistrationData($newData)
    {
        // Get existing registration data
        $existingData = $this->session->get('registration_data') ?? [];
        
        // Merge with new data
        $registrationData = array_merge($existingData, $newData);
        
        // Save back to session
        $this->session->set('registration_data', $registrationData);
    }

    public function checkEmail($email = null)
    {
        if (!$email) {
            return $this->response->setJSON(['available' => false]);
        }

        $exists = $this->userModel->where('email', $email)->first();
        return $this->response->setJSON(['available' => !$exists]);
    }

    public function getDistricts($state = null)
    {
        if (!$state) {
            return $this->response->setJSON([]);
        }

        // This would ideally come from a database, but for now we'll return some sample data
        $districts = [
            'Delhi' => ['New Delhi', 'North Delhi', 'South Delhi', 'East Delhi', 'West Delhi'],
            'Maharashtra' => ['Mumbai', 'Pune', 'Nagpur', 'Thane', 'Nashik'],
            // Add more states and their districts
        ];

        return $this->response->setJSON($districts[$state] ?? []);
    }

    public function getMlaAreas($district = null)
    {
        if (!$district) {
            return $this->response->setJSON([]);
        }

        // This would ideally come from a database
        $mlaAreas = [
            'New Delhi' => ['Chandni Chowk', 'Karol Bagh', 'New Delhi', 'Delhi Cantonment'],
            'Mumbai' => ['Colaba', 'Bandra West', 'Andheri', 'Borivali'],
            // Add more districts and their MLA areas
        ];

        return $this->response->setJSON($mlaAreas[$district] ?? []);
    }

    public function getBlocks($district = null)
    {
        if (!$district) {
            return $this->response->setJSON([]);
        }

        // This would ideally come from a database
        $blocks = [
            'New Delhi' => ['Block A', 'Block B', 'Block C', 'Block D'],
            'Mumbai' => ['Ward A', 'Ward B', 'Ward C', 'Ward D'],
            // Add more districts and their blocks
        ];

        return $this->response->setJSON($blocks[$district] ?? []);
    }

    // ...existing code...
